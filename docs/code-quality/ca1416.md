---
title: 'ca1416: validar la compatibilidad de la plataforma'
ms.date: 09/01/2020
ms.topic: reference
f1_keywords:
- PlatformCompatibilityAnalyzer
- CA1416
helpviewer_keywords:
- PlatformCompatibilityAnalyzer
- CA1416
author: buyaa-n
ms.author: bunamnan
manager: jeffhandley
ms.workload:
- multiple
ms.openlocfilehash: a8185cc625898acd81628f100b6b0bd7d98be417
ms.sourcegitcommit: a18c7e9b367c2f92f6e54c3eaef442775d457667
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 09/15/2020
ms.locfileid: "90108619"
---
# <a name="ca1416-validate-platform-compatibility"></a>CA1416: validar la compatibilidad de la plataforma

|||
|-|-|
|Identificador de comprobación|CA1416|
|Category|Microsoft. Interoperability|
|Cambio importante|Poco problemático|

## <a name="cause"></a>Causa

Se detectan infracciones para el uso de una API dependiente de la plataforma en uno de los contextos siguientes.
- API específica de la plataforma que se usa en: 
  - Contexto de plataforma neutro.
  - Contexto de plataforma diferente.
- La API no es compatible con la plataforma de destino actual.

Esta regla está habilitada de forma predeterminada solo para los proyectos que tienen como destino `net5.0` o posterior. Sin embargo, puede [habilitarlo](#configurability) para los proyectos que tienen como destino otros marcos de trabajo.

## <a name="rule-description"></a>Descripción de la regla

En .NET 5,0 hemos agregado nuevos atributos para anotar las API específicas de la plataforma. Esto funciona de la siguiente manera:
- Se considera que una API no marcada funciona en todas las plataformas de sistema operativo.
- Una API marcada con `[SupportedOSPlatform("platformName")]` solo se considera portable a las plataformas de sistema operativo especificadas (el atributo se puede aplicar varias veces con distintas plataformas).
- Una API marcada con `[UnsupportedOSPlatform("platformName")]` se considera no compatible solo con las plataformas de sistema operativo especificadas (el atributo se puede aplicar varias veces con distintas plataformas).
- Se puede crear una instancia de ambos atributos con o sin números de versión como parte del nombre de la plataforma.
- Si hay una combinación de `[SupportedOSPlatform] and [UnsupportedOSPlatform]` atributos, se agrupan todos los atributos por identificador de plataforma del sistema operativo:
  - **Lista de permitidos**. Si la versión más antigua de cada plataforma de sistema operativo es un `[SupportedOSPlatform]` atributo, se considera que la API solo es compatible con las plataformas de la lista y no es compatible con todas las demás plataformas. La lista podría tener un `[UnsupportedOSPlatform]` atributo con la misma plataforma, pero solo con una versión superior, lo que indica que la API se ha quitado de esa versión.
  - **Lista de denegación**. Si la versión más antigua de cada plataforma de sistema operativo es un `[UnsupportedOSPlatform]` atributo, se considera que la API no es compatible solo con las plataformas de la lista y se admite en todas las demás plataformas. La lista podría tener un `[SupportedOSPlatform]` atributo con la misma plataforma, pero solo con una versión superior, lo que indica que se ha agregado compatibilidad con la API desde esa versión.
  - **Lista incoherente**. Si la versión más antigua de algunas plataformas es `[SupportedOSPlatform]` mientras está `[UnsupportedOSPlatform]` para otras plataformas, se considera incoherente y se omiten algunas anotaciones de la API. Tenemos previsto introducir otro analizador que genere una advertencia en caso de incoherencia en el futuro.

El acceso a las API anotadas con los atributos anteriores desde otro contexto de plataforma podría producir infracciones posteriores.

### <a name="violations"></a>Infracciones
- El acceso a una API que solo se admite en la plataforma especificada ( `[SupportedOSPlatform("platformName")]` ) desde el código accesible en otras plataformas producirá una infracción: `'API' is supported on 'platformName'.`

  ```csharp
  // an API supported only on linux
  [SupportedOSPlatform("linux")]
  public void LinuxOnlyApi() { }

  // an API supported on windows and ios from version 14.0
  [SupportedOSPlatform("windows")]
  [SupportedOSPlatform("ios14.0")]
  public void SupportedOnWindowsAndIos14() { }

  public void Caller()
  {
      LinuxOnlyApi(); // warns CA1416: 'LinuxOnlyApi' is supported on 'linux'
    
      SupportedOnWindowsAndIos14(); // warns CA1416:'SupportedOnWindowsAndIos14' is supported on 'windows'  
                                    // warns CA1416: 'SupportedOnWindowsAndIos14' is supported on 'ios' 14.0 and later
  }

  ```

  > [!NOTE]
  > Solo se produce una infracción si el proyecto no tiene como destino la plataforma compatible ( `net5.0-differentPlatform` ). Esto también se aplica a los proyectos de destino múltiple ( `net5.0` ). No se produce ninguna infracción si el proyecto está destinado a la plataforma especificada ( `net5.0-platformName` ).

- El acceso a una API que se atribuye con `[UnsupportedOSPlatform("platformName")]` desde el contexto que tiene como destino la plataforma con `platformName` podría producir una infracción: `'API' is unsupported on 'platformName'.`

  ```csharp
  // an API not supported on android but supported on all other
  [UnsupportedOSPlatform("android")] 
  public void DoesNotWorkOnAndroid() { }

  // an API was unsupported on windows until version 10.0.1903. The API is considered supported everywhere else without constraints.
  [UnsupportedOSPlatform("windows")]
  [SupportedOSPlatform("windows10.0.1903")]
  public void StartedWindowsSupportFromCertainVersion();

  public void Caller()
  {
      DoesNotWorkOnAndroid(); // warns CA1416:'DoesNotWorkOnAndroid' is unsupported on 'android'
    
      StartedWindowsSupportFromCertainVersion(); // warns CA1416:'StartedWindowsSupportFromCertainVersion' is unsupported on 'windows'  
                                                 // warns CA1416:'StartedWindowsSupportFromCertainVersion' is supported on 'windows' 10.0.1903 and later
  }
  ```

  > [!NOTE]
  > Si está compilando una aplicación que no tiene como destino la plataforma no compatible, no obtendrá ninguna infracción. Solo se produce una infracción en los casos siguientes:
  > - Si el proyecto tiene como destino la plataforma con el atributo no compatible o
  > - El `platformName` está incluido en el grupo elementos predeterminados `MSBuild` `<SupportedPlatform>` o
  > - Incluir manualmente `platformName` en el grupo de `<SupportedPlatform>` elementos de MSBuild:

  ```XML
  <ItemGroup>
      <SupportedPlatform Include="platformName" />
  </ItemGroup>
  ```

## <a name="how-to-fix-violations"></a>Cómo corregir infracciones

La manera recomendada de tratar estas infracciones es asegurarse de que solo llama a estas API cuando se ejecuta en las plataformas adecuadas. Para ello, puede excluir el código en tiempo de compilación mediante #if y la compatibilidad con múltiples versiones, o bien mediante una llamada condicional al código en tiempo de ejecución. El analizador reconocerá las nuevas protecciones de la plataforma que hemos agregado a <xref:System.OperatingSystem> junto con el tradicional <xref:System.Runtime.InteropServices.RuntimeInformation.IsOSPlatform%2A?displayProperty=fullName> que puede usar para la comprobación. 

- Suprimir las infracciones rodeando el sitio de llamada con los métodos de la plataforma Guard

  ```csharp
  // an API supported only on linux
  [SupportedOSPlatform("linux")]
  public void LinuxOnlyApi() { }  

  // an API supported on windows and ios from version 14.0
  [SupportedOSPlatform("windows")]
  [SupportedOSPlatform("ios14.0")]
  public void SupportedOnWindowsAndIos14() { }  
                                              
  public void Caller()
  {
      LinuxOnlyApi(); // warns CA1416: 'LinuxOnlyApi' is supported on 'linux'
    
      SupportedOnWindowsAndIos14(); // warns CA1416:'SupportedOnWindowsAndIos14' is supported on 'windows'  
                                    // warns CA1416: 'SupportedOnWindowsAndIos14' is supported on 'ios' 14.0 and later
  }

  // The diagnostics fixed using platform guard methods
  public void Caller()
  {
      if (OperatingSystem.IsLinux())
      {
          LinuxOnlyApi(); // no diagnostic
      }

      if (OperatingSystem.IsIOSVersionAtLeast(14))
      {
          SupportedOnWindowsAndIos14(); // no diagnostic
      }

      if(RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
      {
          SupportedOnWindowsAndIos14(); // no diagnostic
      }
  }

  // an API not supported on android but supported on all other
  [UnsupportedOSPlatform("android")]  
  public void DoesNotWorkOnAndroid() { }

  // an API was unsupported on windows until version 10.0.1903. The API is considered supported everywhere else without constraints.
  [UnsupportedOSPlatform("windows")]
  [SupportedOSPlatform("windows10.0.1903")]
  public void StartedWindowsSupportFromCertainVersion();

  public void Caller()
  {
      DoesNotWorkOnAndroid(); // warns CA1416:'DoesNotWorkOnAndroid' is unsupported on 'android'
    
      StartedWindowsSupportFromCertainVersion(); // warns CA1416:'StartedWindowsSupportFromCertainVersion' is unsupported on 'windows'  
                                                 // warns CA1416:'StartedWindowsSupportFromCertainVersion' is supported on 'windows' 10.0.1903 and later
  }

  public void Caller()
  {
      if (!OperatingSystem.IsAndroid())
      {
          DoesNotWorkOnAndroid(); // no diagnostic
      }

      // Can use &&, || logical operators to guard combined attributes
      if (!OperatingSystem.IsWindows() || OperatingSystem.IsWindowsVersionAtLeast(10, 0, 1903))
      {
          StartedWindowsSupportFromCertainVersion(); // no diagnostic
      }
  }

  ```

- El analizador también <xref:System.Diagnostics.Debug.Assert%2A?displayProperty=fullName> considera un medio para evitar que el código se alcance en plataformas no compatibles. `Debug.Assert`El uso de permite que la comprobación se recorte fuera de las compilaciones de versión si se desea.

  ```csharp
  // an API supported only on linux
  [SupportedOSPlatform("linux")]
  public void LinuxOnlyApi() { } 

  public void Caller() 
  {
      Debug.Assert(OperatingSystem.IsLinux());

      LinuxOnlyApi(); // No diagnostic
  } 
  ```

- Puede elegir marcar sus propias API como específicas de la plataforma y, por tanto, reenviar los requisitos a los autores de las llamadas. Puede aplicar atributos de plataforma a cualquiera de las siguientes opciones:
  - Tipos
  - Miembros (métodos, campos, propiedades y eventos)
  - Ensamblado

  ```csharp
  [SupportedOSPlatform("windows")]
  [SupportedOSPlatform("ios14.0")]
  public void SupportedOnWindowsAndIos14() { }  

  [SupportedOSPlatform("ios15.0")] // call site version should be equal to or higher than the API version
  public void Caller() 
  { 
      SupportedOnWindowsAndIos14(); // No diagnostics
  } 

  [UnsupportedOSPlatform("windows")]
  [SupportedOSPlatform("windows10.0.1903")]
  public void StartedWindowsSupportFromCertainVersion();

  [UnsupportedOSPlatform("windows")]
  [SupportedOSPlatform("windows10.0.1903")]
  public void Caller() 
  { 
      StartedWindowsSupportFromCertainVersion(); // No diagnostics
  } 
  ```

- Cuando se aplica un atributo de nivel de ensamblado o de tipo, se considera que todos los miembros del ensamblado o tipo son específicos de la plataforma.

  ```csharp
  [assembly:SupportedOSPlatform("windows")]
  public namespace ns
  {
      public class Sample
      {
          public void SupportedOnWindows() { }  
      
          public void Caller() 
          { 
              SupportedOnWindows(); // No diagnostic as call site and calling method both windows only
          }
      }
  } 
  ```

## <a name="when-to-suppress-warnings"></a>Cuándo suprimir advertencias

No se recomienda hacer referencia a las API específicas de la plataforma sin un contexto o protección de plataforma adecuado. Sin embargo, si es necesario, puede suprimir estos diagnósticos de la forma habitual ( `<NoWarn>` , configuración del editor o #pragma):

```csharp
[SupportedOSPlatform("linux")]
public void LinuxOnlyApi() { } 

public void Caller() 
{ 
#pragma warning disable CA1416
    LinuxOnlyApi(); 
#pragma warning restore CA1416
} 
```

## <a name="configurability"></a>Configurabilidad

El analizador está habilitado de forma predeterminada solo para los proyectos `net5.0` que tienen como destino o versiones posteriores y tiene un [AnalysisLevel](https://docs.microsoft.com/dotnet/core/project-sdk/msbuild-props#analysislevel) de 5 (el valor predeterminado para los `net5.0` proyectos). Puede habilitarlo para las plataformas de destino inferiores a `net5.0` , agregando el siguiente par clave-valor a un archivo. editorconfig en el proyecto:

```ini
dotnet_code_quality.enable_platform_analyzer_on_pre_net5_target=true
```

Para obtener más información, vea [configurar los analizadores de calidad de código de .net](configure-fxcop-analyzers.md).

## <a name="see-also"></a>Consulte también

- [Anotar API específicas de la plataforma y detectar su uso](https://github.com/dotnet/designs/blob/master/accepted/2020/platform-checks/platform-checks.md)
- [Anotar API como no compatible en plataformas específicas](https://github.com/dotnet/designs/blob/master/accepted/2020/platform-exclusion/platform-exclusion.md)
- [Nombres de marcos de trabajo de destino en .NET 5](https://github.com/dotnet/designs/blob/master/accepted/2020/net5/net5.md)
- [Analizador de API en .NET](https://docs.microsoft.com/dotnet/standard/analyzers/api-analyzer)
- [Advertencias de interoperabilidad](/dotnet/framework/interop/index)